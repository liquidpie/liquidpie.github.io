"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _slicedToArray=function(){return function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],o=!0,r=!1,i=void 0;try{for(var a,s=t[Symbol.iterator]();!(o=(a=s.next()).done)&&(n.push(a.value),!e||n.length!==e);o=!0);}catch(t){r=!0,i=t}finally{try{!o&&s.return&&s.return()}finally{if(r)throw i}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(e,n,o){return n&&t(e.prototype,n),o&&t(e,o),e}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol?"symbol":typeof t};!function(t,e){"function"==typeof define&&define.amd?define(["d3"],e):"object"===("undefined"==typeof module?"undefined":_typeof(module))&&module.exports?module.exports=function(t){return t.tip=e(t),t.tip}:window.d3.tip=e(d3)}(0,function(t){return function(){var e=function(){var e=t.select(document.createElement("div"));return e.style("position","absolute").style("top",0).style("opacity",0).style("pointer-events","none").style("box-sizing","border-box"),e.node()},n=function(){return null===s&&(s=e(),document.body.appendChild(s)),t.select(s)},o=function(){for(var e=u||t.event.target;void 0===e.getScreenCTM&&"undefined"===e.parentNode;)e=e.parentNode;var n={},o=e.getScreenCTM(),r=e.getBBox(),i=r.width,a=r.height,s=r.x,l=r.y;return c.x=s,c.y=l,n.nw=c.matrixTransform(o),c.x+=i,n.ne=c.matrixTransform(o),c.y+=a,n.se=c.matrixTransform(o),c.x-=i,n.sw=c.matrixTransform(o),c.y-=a/2,n.w=c.matrixTransform(o),c.x+=i,n.e=c.matrixTransform(o),c.x-=i/2,c.y-=a/2,n.n=c.matrixTransform(o),c.y+=a,n.s=c.matrixTransform(o),n},r=function(){return"n"},i=function(){return[0,0]},a=function(){return" "},s=e(),l=null,c=null,u=null,h=function(t){return"function"==typeof t?t:function(){return t}},f=t.map({n:function(){var t=o();return{top:t.n.y-s.offsetHeight,left:t.n.x-s.offsetWidth/2}},s:function(){var t=o();return{top:t.s.y,left:t.s.x-s.offsetWidth/2}},e:function(){var t=o();return{top:t.e.y-s.offsetHeight/2,left:t.e.x}},w:function(){var t=o();return{top:t.w.y-s.offsetHeight/2,left:t.w.x-s.offsetWidth}},nw:function(){var t=o();return{top:t.nw.y-s.offsetHeight,left:t.nw.x-s.offsetWidth}},ne:function(){var t=o();return{top:t.ne.y-s.offsetHeight,left:t.ne.x}},sw:function(){var t=o();return{top:t.sw.y,left:t.sw.x-s.offsetWidth}},se:function(){var t=o();return{top:t.se.y,left:t.e.x}}}),d=f.keys(),p=function(t){var e;l="svg"===(e=(e=t).node()).tagName.toLowerCase()?e:e.ownerSVGElement,c=l.createSVGPoint(),document.body.appendChild(s)};return p.show=function(){var t=Array.prototype.slice.call(arguments);t[t.length-1]instanceof SVGElement&&(u=t.pop());var e,o=a.apply(this,t),s=i.apply(this,t),l=n(),c=document.documentElement.scrollTop||document.body.scrollTop,h=document.documentElement.scrollLeft||document.body.scrollLeft,y=r.apply(this,t),g=d.length;l.html(o).style("position","absolute").style("opacity",1).style("pointer-events","all");var v,m,_=l._groups?l._groups[0][0]:l[0][0],b=_.clientWidth,w=_.clientHeight,C=window.innerWidth,x=window.innerHeight,k=(v=this.getBoundingClientRect(),m=document.documentElement,{top:v.top+(window.pageYOffset||m.scrollTop||0),right:v.right+(window.pageXOffset||0),bottom:v.bottom+(window.pageYOffset||0),left:v.left+(window.pageXOffset||m.scrollLeft||0)}),T=k.top-w<0,S=k.left-b<0,O=k.right+w>C,E=k.bottom+w>x;for(T&&!O&&!E&&S?y="e":!T||O||E||S?T&&O&&!E&&!S?y="w":T||O||E||!S?!T&&!O&&E&&S?y="e":T||O||!E||S?!T&&O&&E&&!S?y="n":T||!O||E||S||(y="w"):y="e":y="e":y="s",r(y);g--;)l.classed(d[g],!1);return e=f.get(y).apply(this),l.classed(y,!0).style("top",e.top+s[0]+c+"px").style("left",e.left+s[1]+h+"px"),p},p.hide=function(){return n().style("opacity",0).style("pointer-events","none"),p},p.attr=function(e){if(arguments.length<2&&"string"==typeof e)return n().attr(e);var o=Array.prototype.slice.call(arguments);return t.selection.prototype.attr.apply(n(),o),p},p.style=function(e){if(arguments.length<2&&"string"==typeof e)return n().style(e);var o=Array.prototype.slice.call(arguments);if(1===o.length)for(var r=o[0],i=Object.keys(r),a=0;a<i.length;a++)t.selection.prototype.style.apply(n(),r[a]);return p},p.direction=function(t){return arguments.length?(r=null==t?t:h(t),p):r},p.offset=function(t){return arguments.length?(i=null==t?t:h(t),p):i},p.html=function(t){return arguments.length?(a=null==t?t:h(t),p):a},p.destroy=function(){return s&&(n().remove(),s=null),p},p}});var RelationshipGraph=function(){function t(e){var n=arguments.length<=1||void 0===arguments[1]?{showTooltips:!0,maxChildCount:0,thresholds:[]}:arguments[1];if(_classCallCheck(this,t),n.thresholds){if("object"!==_typeof(n.thresholds))throw"Thresholds must be an Object."}else n.thresholds=[];void 0!==n.onClick?(this.parentPointer=void 0!==n.onClick.parent,this.childPointer=void 0!==n.onClick.child):(this.parentPointer=!1,this.childPointer=!1);var o={parent:t.noop,child:t.noop};this.configuration={blockSize:24,selection:e,showTooltips:n.showTooltips,maxChildCount:n.maxChildCount||0,onClick:n.onClick||o,showKeys:n.showKeys,thresholds:n.thresholds,colors:n.colors||t.getColors(),transitionTime:n.transitionTime||1500,truncate:n.truncate||0,sortFunction:n.sortFunction||t.sortJson,valueKeyName:n.valueKeyName};for(var r=0;r<this.configuration.colors.length;r++){var i=this.configuration.colors[r];i.indexOf("#")<0&&"string"==typeof i&&6===i.length&&!isNaN(parseInt(i,16))&&(i="#"+i,this.configuration.colors[r]=i)}void 0===this.configuration.showTooltips&&(this.configuration.showTooltips=!0),void 0===this.configuration.showKeys&&(this.configuration.showKeys=!0),void 0===this.configuration.keyValueName&&(this.configuration.keyValueName="value"),this.configuration.thresholds.length&&"number"==typeof this.configuration.thresholds[0]&&this.configuration.thresholds.sort(function(t,e){return t-e}),this.measurementDiv=document.createElement("div"),this.measurementDiv.className="relationshipGraph-measurement",document.body.appendChild(this.measurementDiv),this.measuredCache={},this.representation=[],this._spacing=1,this._d3V4=!!this.configuration.selection._groups;var a,s,l;this.configuration.showTooltips?(this.tooltip=(s=["_PRIVATE_","PARENT","PARENTCOLOR","SETNODECOLOR","SETNODESTROKECOLOR"],l=(a=this).configuration.showKeys,d3.tip().attr("class","relationshipGraph-tip").offset([-8,-10]).html(function(e){for(var n=Object.keys(e),o=document.createElement("table"),r=n.length,i=[];r--;){var c=n[r],u=c.toUpperCase();if(!t.contains(s,u)&&!u.startsWith("__")){var h=document.createElement("tr"),f=l?document.createElement("td"):null,d=document.createElement("td");if(l&&(f.innerHTML=c.charAt(0).toUpperCase()+c.substring(1),h.appendChild(f)),"VALUE"==u&&!a.configuration.valueKeyName)continue;d.innerHTML=e[c],d.style.fontWeight="normal",h.appendChild(d),i.push(h)}}for(var p=i.length;p--;)o.appendChild(i[p]);return o.outerHTML})),this.tooltip.direction("n")):this.tooltip=null,this.svg=this.configuration.selection.select("svg").select("g"),this.svg.empty()&&(this.svg=this.configuration.selection.append("svg").attr("width","500").attr("height","500").attr("style","display: block").append("g").attr("transform","translate(10, 0)")),this.graph=this}return _createClass(t,[{key:"getId",value:function(){var t=this.configuration.selection;return(this._d3V4?t._groups[0][0]:t[0][0]).id}},{key:"getPixelLength",value:function(e){if(t.containsKey(this.measuredCache,e))return this.measuredCache[e];var n=document.createTextNode(e);this.measurementDiv.appendChild(n);var o=this.measurementDiv.offsetWidth;return this.measurementDiv.removeChild(n),this.measuredCache[e]=o,o}},{key:"assignIndexAndRow",value:function(e,n,o){var r="",i=Object.keys(n),a=void 0,s=0,l=0,c="",u=o.length,h=this.configuration,f=h.blockSize,d=h.selection;for(a=0;u>a;a++){var p=o[a]+" ( "+n[i[a]]+") ";p.length>r.length&&(r=p)}var y=this.getPixelLength(r),g=this._d3V4?d._groups[0][0]:d[0][0],v=0===h.maxChildCount?Math.floor((g.parentElement.clientWidth-f-y)/f):h.maxChildCount,m=e.length,_=h.thresholds;for(a=0;m>a;a++){var b=e[a],w=b.parent;if(null!==c&&c!==w?(b.__row=l+1,b.__index=1,s=2,l++):(s===v+1&&(s=1,l++),b.__row=l,b.__index=s,s++),c=w,0===_.length)b.__color=0;else{var C=void 0,x=void 0;if("string"==typeof _[0])C=b.value,x=t.stringCompare;else{var k=b.value;C="number"==typeof k?k:parseFloat(k.replace(/[^0-9-.]+/g,"")),x=t.numericCompare}var T=x(C,_);b.__color=-1===T?0:T,b.__colorValue=this.configuration.colors[b.__color%this.configuration.colors.length]}b.setNodeColor=function(t){this.__node||(this.__node=document.getElementById(this.__id)),this.__node&&(this.__node.style.fill=t)},b.setNodeStrokeColor=function(t){this.__node||(this.__node=document.getElementById(this.__id)),this.__node&&(this.__node.style.strokeWidth=t?"1px":0,this.__node.style.stroke=t||"")},b.__id=this.getId()+"-child-node"+b.__row+"-"+b.__index}return[y,v,l]}},{key:"createParents",value:function(t,e,n,o){var r=Object.keys(e),i=this;t.enter().append("text").text(function(t,n){return t+" ("+e[r[n]]+")"}).attr("x",function(t,o){var a=i.getPixelLength(t+" ("+e[r[o]]+")");return n-a}).attr("y",function(t,n){if(0===n)return 0;for(var a=0,s=n-1;s>-1;)a+=Math.ceil(e[r[s]]/o)*o,s--;return Math.ceil(a/o)*i.configuration.blockSize+i._spacing*n}).style("text-anchor","start").style("fill",function(t){return void 0!==t.parentColor?i.configuration.colors[t.parentColor]:"#000000"}).style("cursor",this.parentPointer?"pointer":"default").attr("class","relationshipGraph-Text").attr("transform","translate(-6, "+i.configuration.blockSize/1.5+")").on("click",function(t){i.configuration.onClick.parent(t)})}},{key:"updateParents",value:function(t,e,n,o){var r=Object.keys(e),i=this;t.text(function(t,n){return t+" ("+e[r[n]]+")"}).attr("x",function(t,o){var a=i.getPixelLength(t+" ("+e[r[o]]+")");return n-a}).attr("y",function(t,n){if(0===n)return 0;for(var a=0,s=n-1;s>-1;)a+=Math.ceil(e[r[s]]/o)*o,s--;return Math.ceil(a/o)*i.configuration.blockSize+i._spacing*n}).style("fill",function(t){return void 0!==t.parentColor?i.configuration.colors[t.parentColor]:"#000000"}).style("cursor",i.parentPointer?"pointer":"default")}},{key:"createChildren",value:function(e,n){var o=this;e.enter().append("rect").attr("id",function(t){return t.__id}).attr("x",function(t){return n+(t.__index-1)*o.configuration.blockSize+5+(o._spacing*t.__index-1)}).attr("y",function(t){return(t.__row-1)*o.configuration.blockSize+(o._spacing*t.__row-1)}).attr("rx",4).attr("ry",4).attr("class","relationshipGraph-block").attr("width",o.configuration.blockSize).attr("height",o.configuration.blockSize).style("fill",function(t){return t.__colorValue}).style("cursor",o.childPointer?"pointer":"default").on("mouseover",o.tooltip?o.tooltip.show:t.noop).on("mouseout",o.tooltip?o.tooltip.hide:t.noop).on("click",function(t){o.tooltip.hide(),o.configuration.onClick.child(t)})}},{key:"updateChildren",value:function(t,e){var n=this.configuration.blockSize,o=this;t.transition(this.configuration.transitionTime).attr("id",function(t){return t.__id}).attr("x",function(t){return e+(t.__index-1)*n+5+(o._spacing*t.__index-1)}).attr("y",function(t){return(t.__row-1)*n+(o._spacing*t.__row-1)}).style("fill",function(t){return t.__colorValue})}},{key:"removeNodes",value:function(t){t.exit().transition(this.configuration.transitionTime).remove()}},{key:"data",value:function(e){if(t.verifyJson(e)){var n,o,r,i=[],a={},s=this.configuration,l=void 0,c=void 0,u=void 0,h=void 0;s.sortFunction(e),this.representation=e;var f=e.length;for(c=0;f>c;c++)l=e[c].parent,t.containsKey(a,l)?a[l]++:(a[l]=1,i.push(t.truncate(l,s.truncate)));var d=this.assignIndexAndRow(e,a,i),p=_slicedToArray(d,3);for(r=p[0],o=p[1],h=(n=p[2])*s.blockSize,u=r+o*s.blockSize,u+=this._spacing*o,c=0;n>c;c++)h+=this._spacing*c;var y=this.svg.selectAll(".relationshipGraph-Text").data(i);this.createParents(y,a,r,o),this.updateParents(y,a,r,o),this.removeNodes(y);var g=this.svg.selectAll(".relationshipGraph-block").data(e);this.createChildren(g,r),this.updateChildren(g,r),this.removeNodes(g),this.configuration.showTooltips&&(d3.select(".d3-tip").remove(),this.svg.call(this.tooltip)),this.configuration.selection.select("svg").attr("width",Math.abs(u+15)).attr("height",Math.abs(h+15))}return this}},{key:"search",value:function(t){var e=[],n=Object.keys(t),o=n.length;if(this.representation&&t)for(var r=this.representation.length,i=0;r>i;i++){for(var a=this.representation[i],s=!1,l=0;o>l;l++){var c=t[n[l]];if(!(s=a[n[l]]==c))break}s&&e.push(a)}return e}}],[{key:"getColors",value:function(){return["#c4f1be","#a2c3a4","#869d96","#525b76","#201e50","#485447","#5b7f77","#6474ad","#b9c6cb","#c0d6c1","#754668","#587d71","#4daa57","#b5dda4","#f9eccc","#0e7c7b","#17bebb","#d4f4dd","#d62246","#4b1d3f","#cf4799","#c42583","#731451","#f3d1bf","#c77745"]}},{key:"containsKey",value:function(t,e){return Object.keys(t).indexOf(e)>-1}},{key:"contains",value:function(t,e){return t.indexOf(e)>-1}},{key:"truncate",value:function(t,e){return e&&t&&t.length>e?t.substring(0,e)+"...":t}},{key:"isArray",value:function(t){return"[object Array]"==Object.prototype.toString.call(t)}},{key:"noop",value:function(){}},{key:"sortJson",value:function(t){t.sort(function(t,e){var n=t.parent.toLowerCase(),o=e.parent.toLowerCase();return n>o?1:o>n?-1:0})}},{key:"stringCompare",value:function(t,e){if("string"!=typeof t)throw"Cannot make value comparison between a string and a "+(void 0===t?"undefined":_typeof(t))+".";if(!e||!e.length)throw"Cannot find correct threshold because there are no thresholds.";for(var n=e.length,o=0;n>o;o++)if(t==e[o])return o;return-1}},{key:"numericCompare",value:function(t,e){if("number"!=typeof t)throw"Cannot make value comparison between a number and a "+(void 0===t?"undefined":_typeof(t))+".";if(!e||!e.length)throw"Cannot find correct threshold because there are no thresholds.";for(var n=e.length,o=0;n>o;o++)if(t<=e[o])return o;return-1}},{key:"verifyJson",value:function(e){if(!t.isArray(e)||e.length<0||"object"!==_typeof(e[0]))throw"JSON has to be an Array of JavaScript objects that is not empty.";for(var n=e.length;n--;){var o=e[n],r=Object.keys(o),i=r.length,a=o.parentColor;if(void 0===o.parent)throw"Child does not have a parent.";if(void 0!==a&&(a>4||0>a))throw"Parent color is unsupported.";for(;i--;)if("VALUE"==r[i].toUpperCase()){"value"!=r[i]&&(e[n].value=e[n][r[i]],delete e[n][r[i]]);break}}return!0}}]),t}();d3.relationshipGraph=function(){return RelationshipGraph.extend.apply(RelationshipGraph,arguments)},d3.selection.prototype.relationshipGraph=function(t){return new RelationshipGraph(this,t)};